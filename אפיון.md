בטח, אני אצור לך סיכום מפורט ומקיף של כל האפיון של המערכת שלנו, מחולק לחלקים ברורים, כדי שנוכל לוודא שאנחנו מבינים הכל באותה צורה.

חלקי האפיון המפורט:

תפקידים והרשאות משתמשים: פירוט של כל סוגי המשתמשים במערכת, התפקידים שלהם וההרשאות שלהם בממשק המפעילים ובגישה לנתונים בפיירבייס.

מבנה נתונים מפורט ב-Firebase Firestore: תיאור מפורט של כל האוספים, אוספי המשנה, והשדות בכל אוסף, כולל סוגי הנתונים והקשרים בין האוספים.

תהליך יצירת לקוח חדש (מנהל מערכת): הסבר מפורט של הצעדים שאתה כמנהל מערכת צריך לבצע כדי ליצור לקוח חדש בפיירבייס, כולל יצירת משתמש מנהל לקוח והגדרת אזור שיפוט.

סיכום מקיף של אפיון המערכת (מחולק לחלקים):

1. תפקידים והרשאות משתמשים:

במערכת שלנו יהיו ארבעה תפקידים שונים למשתמשים בממשק המפעילים, עם רמות הרשאה שונות:

מנהל מערכת (System Administrator - אתה):

תפקיד: התפקיד הבכיר ביותר במערכת. אתה, כמפתח האפליקציה, תהיה מנהל המערכת.

הרשאות:

ניהול לקוחות (Customers): יצירה, עריכה ומחיקה של לקוחות חדשים במערכת (ארגוני ביטחון, עיריות וכו'). זה כולל הגדרת אזור השיפוט הראשי של כל לקוח. ניהול לקוחות מתבצע ישירות בפיירבייס (באמצעות סקריפטים או ידנית), ולא דרך ממשק המפעילים.

גישה מלאה לכל הנתונים במערכת: גישה לקריאה וכתיבה לכל האוספים והמסמכים בפיירבייס (לצורך תחזוקה, ניטור, וניהול המערכת).

גישה לכל תכונות ממשק המפעילים: גישה לכל המסכים והפונקציות בממשק הניהול (לוח בקרה, ניהול אזורי התרעה, ניהול משתמשים, וכו').

חשוב: מנהל מערכת לא מנהל אזורי התרעה או משתמשים בתוך אזורי שיפוט ספציפיים. מנהל מערכת אחראי רק על ניהול לקוחות ברמה העליונה.

מנהל לקוח (Customer Administrator):

תפקיד: אחראי ביטחון ראשי או מנהל מטעם הלקוח (ארגון) שלך (למשל, מנהל ביטחון בעירייה). לכל לקוח יהיה מנהל לקוח ראשי אחד (או יותר, אם תרצה לאפשר).

הרשאות:

כניסה לממשק ניהול (דשבורד) ייעודי ללקוח שלו.

ניהול אזורי התרעה (Alert Areas) בתוך תחום השיפוט שלו: יצירה, עריכה ומחיקה של אזורי התרעה פנימיים יותר בתוך תחום השיפוט הראשי של הלקוח.

הפעלת התראות (Alerts) בתוך אזורי ההתרעה שלו.

צפייה במפה בזמן אמת עם דיווחי משתמשים בתוך תחום השיפוט שלו.

ניהול מפעילי משנה (Operators) שלו: הוספה, מחיקה וניהול תפקידים של מפעילי משנה (מנהל וצופה) בתוך תחום השיפוט שלו.

גישה לנתונים בפיירבייס: גישה לקריאה וכתיבה מוגבלת רק לנתונים ששייכים ללקוח שלו (אוספים משניים operators ו-alertAreas בתוך מסמכי customers, אוסף alerts ו-reports ששייכים לאזורי התרעה שלו).

לא יכול: לנהל אזורי שיפוט ראשיים, לנהל לקוחות אחרים, לנהל מנהלי מערכת, לצאת מתחום השיפוט שלו.

מפעיל מנהל (Operator Administrator - משנה):

תפקיד: מפעיל משנה עם הרשאות ניהול מוגבלות (למשל, קצין משמרת במוקד עירוני). נוצר ומנוהל על ידי מנהל הלקוח.

הרשאות:

כניסה לממשק ניהול.

ניהול אזורי התרעה (Alert Areas) מוגבלים: בהתאם להרשאות שניתנו לו על ידי מנהל הלקוח, הוא יכול לקבל הרשאה לנהל אזורי התרעה ספציפיים או את כל אזורי ההתרעה בתוך אזור השיפוט של הלקוח (יצירה, עריכה, מחיקה).

הפעלת התראות (Alerts) מוגבלות: יכול להפעיל התראות רק באזורי ההתרעה שלהם יש לו הרשאה.

צפייה במפה בזמן אמת עם דיווחי משתמשים רק באזורים להם יש הרשאה.

גישה לנתונים בפיירבייס: גישה לקריאה וכתיבה מוגבלת רק לנתונים ששייכים לאזורים להם יש לו הרשאה (אוסף משני alertAreas ספציפיים בתוך אזור שיפוט, אוסף alerts ו-reports ששייכים לאזורים אלה).

לא יכול: לנהל אזורי שיפוט ראשיים, לנהל לקוחות, לנהל מנהלי מערכת או מנהלי לקוחות, לנהל מפעילי מנהל משנה אחרים (אלא אם יש לו הרשאה מפורשת).

מפעיל צופה (Operator Viewer - משנה):

תפקיד: מפעיל משנה עם הרשאות צפייה בלבד (למשל, גורם ביטחון שצריך להיות מודע למצב אבל לא להפעיל התראות). נוצר ומנוהל על ידי מנהל הלקוח.

הרשאות:

כניסה לממשק ניהול.

צפייה במפה בזמן אמת עם דיווחי משתמשים באזורים להם יש הרשאה.

צפייה ברשימות של אזורי התרעה ומשתמשים (במצב "צפייה בלבד", ללא אפשרות עריכה) באזורים להם יש הרשאה.

גישה לנתונים בפיירבייס: גישה לקריאה בלבד לנתונים ששייכים לאזורים להם יש הרשאה (אוסף משני alertAreas ספציפיים בתוך אזור שיפוט, אוסף alerts ו-reports ששייכים לאזורים אלה).

לא יכול: להפעיל התראות, ליצור/לעדכן/למחוק אזורים או משתמשים, לנהל אזורי שיפוט ראשיים או לקוחות, לנהל מפעילי מנהל משנה או צופים אחרים.

2. מבנה נתונים מפורט ב-Firebase Firestore (מעודכן):

אוסף ראשי customers (לקוחות):

מזהה מסמך (Document ID): מזהה ייחודי לכל לקוח (אוטומטי של Firestore או מותאם אישית).

שדות (Fields) במסמך customer:

name (String, חובה): שם הלקוח (למשל, שם הארגון).

jurisdictionArea (GeoPoint Array, חובה): פוליגון גיאוגרפי של אזור השיפוט הראשי.

boundingBox (GeoPoint Array, חובה): חסם תוחם של הפוליגון.

אוסף משני operators בתוך כל מסמך customer (מפעילים של לקוח ספציפי):

מיקום: customers/{customerId}/operators

מזהה מסמך (Document ID): מזהה ייחודי לכל מפעיל (מזהה משתמש Firebase Authentication).

שדות (Fields) במסמך operator:

username (String, חובה): שם משתמש לכניסה למערכת.

role (String, חובה): תפקיד המפעיל: "admin", "viewer", "customer-admin".

אוסף משני alertAreas בתוך כל מסמך customer (אזורי התרעה של לקוח ספציפי):

מיקום: customers/{customerId}/alertAreas

מזהה מסמך (Document ID): מזהה ייחודי לכל אזור התרעה (אוטומטי של Firestore).

שדות (Fields) במסמך alertArea:

name (String, חובה): שם אזור ההתרעה.

geoPolygon (GeoPoint Array, חובה): פוליגון גיאוגרפי של אזור ההתרעה.

boundingBox (GeoPoint Array, חובה): חסם תוחם של הפוליגון.

createdAt (Timestamp, חובה): חותמת זמן יצירת האזור.

createdByOperatorId (String, חובה): מזהה מפעיל שיצר את אזור ההתרעה. מפתח זר לאוסף customers/{customerId}/operators.

אוסף משני alerts בתוך כל מסמך alertArea (התרעות עבור אזור התרעה ספציפי):

מיקום: customers/{customerId}/alertAreas/{alertAreaId}/alerts

מזהה מסמך (Document ID): מזהה ייחודי לכל התראה (אוטומטי של Firestore).

שדות (Fields) במסמך alert:

type (String, אופציונלי): סוג האירוע.

message (String, אופציונלי): הודעה מותאמת אישית.

createdAt (Timestamp, חובה): חותמת זמן יצירת ההתרעה.

isActive (Boolean, חובה): האם ההתרעה פעילה.

operatorId (String, חובה): מזהה מפעיל שהפעיל את ההתרעה. מפתח זר לאוסף customers/{customerId}/operators.

אוסף משני reports בתוך כל מסמך alert (דיווחים עבור התראה ספציפית):

מיקום: customers/{customerId}/alertAreas/{alertAreaId}/alerts/{alertId}/reports

מזהה מסמך (Document ID): מזהה ייחודי לכל דיווח (אוטומטי של Firestore).

שדות (Fields) במסמך report:

status (String, חובה): סטטוס המשתמש (danger, safe, unsafe-but-ok).

geoPoint (GeoPoint, חובה): מיקום גיאוגרפי של המשתמש.

createdAt (Timestamp, חובה): חותמת זמן יצירת הדיווח.

userId (String, אופציונלי).

3. תהליך יצירת לקוח חדש (מנהל מערכת - אתה):

כמנהל מערכת, אתה תהיה אחראי על יצירת לקוחות חדשים (ארגוני ביטחון, עיריות וכו') במערכת. יצירת לקוח חדש כוללת את הצעדים הבאים (לביצוע ישירות בפיירבייס, לא דרך ממשק המפעילים):

יצירת משתמש חדש ב-Firebase Authentication עבור מנהל הלקוח:

אתה יכול להשתמש ב-Firebase Admin SDK (כמו בסקריפטים שלנו) כדי ליצור משתמש חדש ב-Firebase Authentication.

אתה תגדיר עבורו:

שם משתמש (Username) ייחודי (למשל, tel-aviv-admin).

סיסמה התחלתית (המערכת תייצר סיסמה אקראית, ותספק אותה לך).

תפקיד (Role): customer-admin.

חשוב: לאחר יצירת המשתמש, עליך לשמור את ה-UID (User ID) הייחודי ש-Firebase Authentication יצר עבור המשתמש הזה. תזדקק ל-UID הזה בשלב הבא.

יצירת מסמך לקוח חדש באוסף customers ב-Firestore:

אתה יכול להשתמש ב-Firebase Admin SDK (בסקריפט) או ב-Firestore Console כדי ליצור מסמך חדש באוסף הראשי customers.

עבור המסמך החדש, תגדיר את השדות הבאים:

name: שם הלקוח (למשל, "עיריית תל אביב").

jurisdictionArea: פוליגון גיאוגרפי של אזור השיפוט הראשי (תצטרך להגדיר את הפוליגון הזה ידנית או באמצעות כלי גיאוגרפי, ולייצג אותו כמערך של GeoPoint).

boundingBox: חשב את חסם התוחם (Bounding Box) של הפוליגון באמצעות פונקציה כמו calculateBoundingBox בסקריפטים שלנו, ושמור אותו בשדה זה.

adminUserId: הדבק כאן את ה-UID שקיבלת בשלב 1 (מזהה משתמש Firebase Authentication של מנהל הלקוח).

יצירת מנהל לקוח ראשוני באוסף המשני operators:

בתוך מסמך הלקוח החדש שיצרת באוסף customers, צור אוסף משני חדש בשם operators.

בתוך האוסף המשני operators, צור מסמך חדש עבור מנהל הלקוח הראשי.

עבור המסמך החדש, תגדיר את השדות הבאים:

Document ID: השתמש ב-UID שקיבלת בשלב 1 כמזהה המסמך (זה מבטיח קישור ישיר בין משתמש Firebase Authentication למסמך המפעיל שלו).

username: שם המשתמש שהגדרת בשלב 1.

role: customer-admin.

לאחר ביצוע שלושת הצעדים האלה, לקוח חדש יהיה מוגדר במערכת:

יהיה לו חשבון משתמש מנהל לקוח ב-Firebase Authentication.

יהיה לו מסמך לקוח באוסף customers עם פרטי אזור השיפוט.

יהיה לו מסמך מפעיל ראשוני באוסף המשני operators עם תפקיד "מנהל לקוח" שמקושר למשתמש Firebase Authentication שלו ולאזור השיפוט שלו.

מה השלב הבא?

אחרי שאישרת את האפיון המעודכן הזה, נוכל להתקדם לשלב הבא - יצירת סקריפט create_customer.js שיאפשר לך לבצע את התהליך הזה של יצירת לקוח חדש בצורה אוטומטית יותר.
